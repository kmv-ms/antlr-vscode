export class CallGraphRenderer {
    data;
    initialDiameter = 1000;
    diameter = this.initialDiameter;
    initialScale = 0.75;
    svg;
    topGroup;
    cluster;
    nodeSelection;
    linkSelection;
    constructor(data) {
        this.data = data;
        const radius = this.diameter / 2;
        this.svg = d3.select("svg")
            .attr("xmlns", "http://www.w3.org/2000/svg")
            .attr("version", "1.1")
            .attr("viewBox", `0 0 ${this.diameter} ${this.diameter}`);
        this.topGroup = this.svg.append("g");
        const zoom = d3.zoom()
            .scaleExtent([0.1 * this.initialScale, 10 * this.initialScale])
            .on("zoom", (event) => {
            this.topGroup.attr("transform", event.transform.toString());
        });
        this.svg
            .call(zoom)
            .call(zoom.transform, d3.zoomIdentity
            .translate(radius, radius)
            .scale(this.initialScale))
            .on("dblclick.zoom", null);
        this.cluster = d3.cluster().size([360, radius * 0.9]);
    }
    render() {
        const radius = this.diameter / 2;
        this.cluster.size([360, radius * 0.9]);
        const line = d3.lineRadial()
            .radius((node) => {
            return node.y;
        })
            .angle((node) => {
            return node.x / 180 * Math.PI;
        })
            .curve(d3.curveBundle.beta(0.75));
        this.linkSelection = this.topGroup.append("g").selectAll(".link");
        this.nodeSelection = this.topGroup.append("g").selectAll(".node");
        const root = d3.hierarchy(this.packageHierarchy(this.data), (d) => {
            return d.children;
        });
        const nodes = root.descendants();
        const linkPairs = this.packageReferences(nodes);
        this.cluster(root);
        this.linkSelection = this.linkSelection
            .data(linkPairs)
            .enter().append("path")
            .attr("class", "link")
            .attr("d", (link) => {
            return line(link.source.path(link.target));
        });
        this.nodeSelection = this.nodeSelection
            .data(nodes.filter((n) => {
            return !n.children;
        }))
            .enter().append("text")
            .attr("class", (d) => {
            return "node " + d.data.class;
        })
            .attr("dy", "0.31em")
            .attr("transform", (d) => {
            return `rotate(${(d.x - 90)})translate(${(d.y + 10)},0)` +
                (d.x < 180 ? "" : "rotate(180)");
        })
            .style("text-anchor", (d) => {
            return d.x < 180 ? "start" : "end";
        })
            .text((d) => {
            return d.data.key;
        })
            .on("mouseover", this.onMouseOver)
            .on("mouseout", this.onMouseOut);
    }
    changeDiameter(factor) {
        this.topGroup.selectChildren().remove();
        this.diameter *= factor;
        this.diameter = this.diameter < 100 ? 100 : (this.diameter > 10000 ? 10000 : this.diameter);
        this.render();
    }
    onMouseOver = (_event, node) => {
        this.nodeSelection.each((n) => {
            n.data.isSource = false;
            n.data.isTarget = false;
        });
        this.linkSelection
            .classed("link-target", (link) => {
            if (link.target === node) {
                return link.source.data.isSource = true;
            }
            else {
                return false;
            }
        })
            .classed("link-source", (link) => {
            if (link.source === node) {
                return link.target.data.isTarget = true;
            }
            else {
                return false;
            }
        })
            .classed("link-dimmed", (link) => {
            return (link.source !== node) && (link.target !== node);
        });
        this.nodeSelection
            .classed("node-target", (n) => {
            return n.data.isTarget;
        })
            .classed("node-source", (n) => {
            return n.data.isSource;
        });
    };
    onMouseOut = (_event, _node) => {
        this.linkSelection.classed("link-dimmed", false);
        this.linkSelection
            .classed("link-target", false)
            .classed("link-source", false);
        this.nodeSelection
            .classed("node-target", false)
            .classed("node-source", false);
    };
    packageHierarchy(entries) {
        const map = {};
        const modules = [];
        const find = (name, rule) => {
            let node = map[name];
            if (!node) {
                node = rule || {
                    name,
                    children: [],
                };
                map[name] = node;
                if (name.length > 0) {
                    const i = name.lastIndexOf(".");
                    node.parent = find(name.substring(0, i));
                    node.parent.children.push(node);
                    let index = modules.indexOf(node.parent.name);
                    if (index < 0) {
                        modules.push(node.parent.name);
                        index = modules.length - 1;
                    }
                    node.class = `module-${index % 10}`;
                    node.key = name.substring(i + 1);
                }
            }
            return node;
        };
        entries.forEach((rule) => {
            find(rule.name, rule);
        });
        return map[""];
    }
    packageReferences(nodes) {
        const map = {};
        const references = [];
        nodes.forEach((node) => {
            map[node.data.name] = node;
        });
        nodes.forEach((node) => {
            if (node.data.references) {
                node.data.references.forEach((name) => {
                    references.push({
                        source: map[node.data.name],
                        target: map[name],
                    });
                });
            }
        });
        return references;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiQ2FsbEdyYXBoUmVuZGVyZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zcmMvd2Vidmlldy1zY3JpcHRzL0NhbGxHcmFwaFJlbmRlcmVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQThCQSxNQUFNLE9BQU8saUJBQWlCO0lBYUM7SUFaVixlQUFlLEdBQUcsSUFBSSxDQUFDO0lBRWhDLFFBQVEsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDO0lBQ2hDLFlBQVksR0FBRyxJQUFJLENBQUM7SUFFcEIsR0FBRyxDQUF1RTtJQUMxRSxRQUFRLENBQXVFO0lBQy9FLE9BQU8sQ0FBeUM7SUFFaEQsYUFBYSxDQUF5QjtJQUN0QyxhQUFhLENBQXlCO0lBRTlDLFlBQTJCLElBQXVCO1FBQXZCLFNBQUksR0FBSixJQUFJLENBQW1CO1FBQzlDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDO1FBRWpDLElBQUksQ0FBQyxHQUFHLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBbUMsS0FBSyxDQUFDO2FBQ3hELElBQUksQ0FBQyxPQUFPLEVBQUUsNEJBQTRCLENBQUM7YUFDM0MsSUFBSSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUM7YUFDdEIsSUFBSSxDQUFDLFNBQVMsRUFBRSxPQUFPLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUM7UUFFOUQsSUFBSSxDQUFDLFFBQVEsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVyQyxNQUFNLElBQUksR0FBRyxFQUFFLENBQUMsSUFBSSxFQUFFO2FBQ2pCLFdBQVcsQ0FBQyxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsWUFBWSxFQUFFLEVBQUUsR0FBRyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDOUQsRUFBRSxDQUFDLE1BQU0sRUFBRSxDQUFDLEtBQXVELEVBQUUsRUFBRTtZ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LENBQUM7SUFDbkIsQ0FBQztJQUVPLGlCQUFpQixDQUFDLEtBQTRCO1FBQ2xELE1BQU0sR0FBRyxHQUE0QyxFQUFFLENBQUM7UUFDeEQsTUFBTSxVQUFVLEdBQStCLEVBQUUsQ0FBQztRQUdsRCxLQUFLLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxFQUFFLEVBQUU7WUFDbkIsR0FBRyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDO1FBQy9CLENBQUMsQ0FBQyxDQUFDO1FBR0gsS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ25CLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLEVBQUU7Z0JBQ3RCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLE9BQU8sQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO29CQUNsQyxVQUFVLENBQUMsSUFBSSxDQUFDO3dCQUNaLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUM7d0JBQzNCLE1BQU0sRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDO3FCQUNwQixDQUFDLENBQUM7Z0JBQ1AsQ0FBQyxDQUFDLENBQUM7YUFDTjtRQUNMLENBQUMsQ0FBQyxDQUFDO1FBRUgsT0FBTyxVQUFVLENBQUM7SUFDdEIsQ0FBQztDQUVKIiwic291cmNlc0NvbnRlbnQiOlsiLypcclxuICogQ29weXJpZ2h0IChjKSBNaWtlIExpc2Noa2UuIEFsbCByaWdodHMgcmVzZXJ2ZWQuXHJcbiAqIExpY2Vuc2VkIHVuZGVyIHRoZSBNSVQgTGljZW5zZS4gU2VlIExpY2Vuc2UudHh0IGluIHRoZSBwcm9qZWN0IHJvb3QgZm9yIGxpY2Vuc2UgaW5mb3JtYXRpb24uXHJcbiAqL1xyXG5cclxuaW1wb3J0IHsgSUNhbGxHcmFwaEVudHJ5IH0gZnJvbSBcIi4vdHlwZXNcIjtcclxuXHJcbmludGVyZmFjZSBJQ2FsbEdyYXBoUmVuZGVyTm9kZSBleHRlbmRzIElDYWxsR3JhcGhFbnRyeSB7XHJcbiAgICBjbGFzczogc3RyaW5nO1xyXG4gICAga2V5OiBzdHJpbmc7XHJcblxyXG4gICAgcGFyZW50OiBJQ2FsbEdyYXBoUmVuZGVyTm9kZTtcclxuICAgIGNoaWxkcmVuOiBJQ2FsbEdyYXBoUmVuZGVyTm9kZVtdO1xyXG5cclxuICAgIC8vIEZpZWxkcyB1c2VkIGluIG1vdXNlIGV2ZW50cyB0byBtYXJrIGlmIHRoaXMgbm9kZSBpcyBlaXRoZXIgdGhlIHNvdXJjZSBvciB0aGUgdGFyZ2V0IG5vZGUgaW5cclxuICAgIC8vIHRoZSBjdXJyZW50bHkgc2VsZWN0ZWQgbGluay5cclxuICAgIGlzU291cmNlOiBib29sZWFuO1xyXG4gICAgaXNUYXJnZXQ6IGJvb2xlYW47XHJcbn1cclxuXHJcbi8vIFR5cGUgYWxpYXNlcyBmb3IgYmV0dGVyIGhhbmRsaW5nL3JlYWRpbmcuXHJcbnR5cGUgQ2FsbEdyYXBoTGF5b3V0Tm9kZSA9IGQzLkhpZXJhcmNoeVBvaW50Tm9kZTxJQ2FsbEdyYXBoUmVuZGVyTm9kZT47XHJcbnR5cGUgQ2FsbEdyYXBoTm9kZVNlbGVjdGlvbiA9IGQzLlNlbGVjdGlvbjxTVkdFbGVtZW50LCBDYWxsR3JhcGhMYXlvdXROb2RlLCBTVkdFbGVtZW50LCBJQ2FsbEdyYXBoUmVuZGVyTm9kZT47XHJcbnR5cGUgQ2FsbEdyYXBoTGlua1NlbGVjdGlvbiA9IGQzLlNlbGVjdGlvbjxTVkdFbGVtZW50LCBJQ2FsbEdyYXBoTGF5b3V0Tm9kZUxpbmssIFNWR0VsZW1lbnQsIElDYWxsR3JhcGhSZW5kZXJOb2RlPjtcclxuXHJcbmludGVyZmFjZSBJQ2FsbEdyYXBoTGF5b3V0Tm9kZUxpbmsge1xyXG4gICAgc291cmNlOiBDYWxsR3JhcGhMYXlvdXROb2RlO1xyXG4gICAgdGFyZ2V0OiBDYWxsR3JhcGhMYXlvdXROb2RlO1xyXG59XHJcblxyXG5leHBvcnQgY2xhc3MgQ2FsbEdyYXBoUmVuZGVyZXIge1xyXG4gICAgcHJpdmF0ZSByZWFkb25seSBpbml0aWFsRGlhbWV0ZXIgPSAxMDAwO1xyXG5cclxuICAgIHByaXZhdGUgZGlhbWV0ZXIgPSB0aGlzLmluaXRpYWxEaWFtZXRlcjtcclxuICAgIHByaXZhdGUgaW5pdGlhbFNjYWxlID0gMC43NTtcclxuXHJcbiAgICBwcml2YXRlIHN2ZzogZDMuU2VsZWN0aW9uPFNWR0VsZW1lbnQsIElDYWxsR3JhcGhSZW5kZXJOb2RlLCBIVE1MRWxlbWVudCwgdW5rbm93bj47XHJcbiAgICBwcml2YXRlIHRvcEdyb3VwOiBkMy5TZWxlY3Rpb248U1ZHRWxlbWVudCwgSUNhbGxHcmFwaFJlbmRlck5vZGUsIEhUTUxFbGVtZW50LCB1bmtub3duPjtcclxuICAgIHByaXZhdGUgY2x1c3RlcjogZDMuQ2x1c3RlckxheW91dDxJQ2FsbEdyYXBoUmVuZGVyTm9kZT47XHJcblxyXG4gICAgcHJpdmF0ZSBub2RlU2VsZWN0aW9uOiBDYWxsR3JhcGhOb2RlU2VsZWN0aW9uO1xyXG4gICAgcHJpdmF0ZSBsaW5rU2VsZWN0aW9uOiBDYWxsR3JhcGhMaW5rU2VsZWN0aW9uO1xyXG5cclxuICAgIHB1YmxpYyBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGE6IElDYWxsR3JhcGhFbnRyeVtdKSB7XHJcbiAgICAgICAgY29uc3QgcmFkaXVzID0gdGhpcy5kaWFtZXRlciAvIDI7XHJcblxyXG4gICAgICAgIHRoaXMuc3ZnID0gZDMuc2VsZWN0PFNWR0VsZW1lbnQsIElDYWxsR3JhcGhSZW5kZXJOb2RlPihcInN2Z1wiKVxyXG4gICAgICAgICAgICAuYXR0cihcInhtbG5zXCIsIFwiaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmdcIilcclxuICAgICAgICAgICAgLmF0dHIoXCJ2ZXJzaW9uXCIsIFwiMS4xXCIpXHJcbiAgICAgICAgICAgIC5hdHRyKFwidmlld0JveFwiLCBgMCAwICR7dGhpcy5kaWFtZXRlcn0gJHt0aGlzLmRpYW1ldGVyfWApO1xyXG5cclxuICAgICAgICB0aGlzLnRvcEdyb3VwID0gdGhpcy5zdmcuYXBwZW5kKFwiZ1wiKTtcclxuXHJcbiAgICAgICAgY29uc3Qgem9vbSA9IGQzLnpvb20oKVxyXG4gICAgICAgICAgICAuc2NhbGVFeHRlbnQoWzAuMSAqIHRoaXMuaW5pdGlhbFNjYWxlLCAxMCAqIHRoaXMuaW5pdGlhbFNjYWxlXSlcclxuICAgICAgICAgICAgLm9uKFwiem9vbVwiLCAoZXZlbnQ6IGQzLkQzWm9vbUV2ZW50PFNWR0VsZW1lbnQsIElDYWxsR3JhcGhSZW5kZXJOb2RlPikgPT4ge1xyXG4gICAgICAgICAgICAgICAgdGhpcy50b3BHcm91cC5hdHRyKFwidHJhbnNmb3JtXCIsIGV2ZW50LnRyYW5zZm9ybS50b1N0cmluZygpKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMuc3ZnXHJcbiAgICAgICAgICAgIC5jYWxsKHpvb20pXHJcbiAgICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvdW5ib3VuZC1tZXRob2RcclxuICAgICAgICAgICAgLmNhbGwoem9vbS50cmFuc2Zvcm0sIGQzLnpvb21JZGVudGl0eVxyXG4gICAgICAgICAgICAgICAgLnRyYW5zbGF0ZShyYWRpdXMsIHJhZGl1cylcclxuICAgICAgICAgICAgICAgIC5zY2FsZSh0aGlzLmluaXRpYWxTY2FsZSksXHJcbiAgICAgICAgICAgIClcclxuICAgICAgICAgICAgLm9uKFwiZGJsY2xpY2suem9vbVwiLCBudWxsKTtcclxuXHJcbiAgICAgICAgdGhpcy5jbHVzdGVyID0gZDMuY2x1c3RlcjxJQ2FsbEdyYXBoUmVuZGVyTm9kZT4oKS5zaXplKFszNjAsIHJhZGl1cyAqIDAuOV0pO1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyByZW5kZXIoKTogdm9pZCB7XHJcbiAgICAgICAgY29uc3QgcmFkaXVzID0gdGhpcy5kaWFtZXRlciAvIDI7XHJcblxyXG4gICAgICAgIHRoaXMuY2x1c3Rlci5zaXplKFszNjAsIHJhZGl1cyAqIDAuOV0pO1xyXG5cclxuICAgICAgICBjb25zdCBsaW5lID0gZDMubGluZVJhZGlhbDxDYWxsR3JhcGhMYXlvdXROb2RlPigpXHJcbiAgICAgICAgICAgIC5yYWRpdXMoKG5vZGUpID0+IHtcclxuICAgICAgICAgICAgICAgIHJldHVybiBub2RlLnk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5hbmdsZSgobm9kZSkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIG5vZGUueCAvIDE4MCAqIE1hdGguUEk7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC5jdXJ2ZShkMy5jdXJ2ZUJ1bmRsZS5iZXRhKDAuNzUpKTtcclxuXHJcbiAgICAgICAgdGhpcy5saW5rU2VsZWN0aW9uID0gdGhpcy50b3BHcm91cC5hcHBlbmQoXCJnXCIpLnNlbGVjdEFsbDxTVkdFbGVtZW50LCBJQ2FsbEdyYXBoTGF5b3V0Tm9kZUxpbms+KFwiLmxpbmtcIik7XHJcbiAgICAgICAgdGhpcy5ub2RlU2VsZWN0aW9uID0gdGhpcy50b3BHcm91cC5hcHBlbmQoXCJnXCIpLnNlbGVjdEFsbDxTVkdFbGVtZW50LCBDYWxsR3JhcGhMYXlvdXROb2RlPihcIi5ub2RlXCIpO1xyXG5cclxuICAgICAgICAvLyBkMy5oaWVyYXJjaHkgcmV0dXJucyBhIG5vZGUgd2l0aG91dCBsYXlvdXQgY29vcmRpbmF0ZXMsIHNvIHRlY2huaWNhbGx5IGl0J3Mgbm90IGEgcG9pbnQgbm9kZSAoeWV0KS5cclxuICAgICAgICAvLyBIb3dldmVyLCBvbmNlIHRoZSBjbHVzdGVyIGxheW91dCBwcm9jZXNzIHdlbnQgdGhyb3VnaCBpdCBiZWNvbWVzIG9uZS5cclxuICAgICAgICBjb25zdCByb290ID0gZDMuaGllcmFyY2h5KHRoaXMucGFja2FnZUhpZXJhcmNoeSh0aGlzLmRhdGEpLCAoZCkgPT4ge1xyXG4gICAgICAgICAgICByZXR1cm4gZC5jaGlsZHJlbjtcclxuICAgICAgICB9KSBhcyBDYWxsR3JhcGhMYXlvdXROb2RlO1xyXG4gICAgICAgIGNvbnN0IG5vZGVzID0gcm9vdC5kZXNjZW5kYW50cygpO1xyXG5cclxuICAgICAgICBjb25zdCBsaW5rUGFpcnMgPSB0aGlzLnBhY2thZ2VSZWZlcmVuY2VzKG5vZGVzKTtcclxuXHJcbiAgICAgICAgdGhpcy5jbHVzdGVyKHJvb3QpO1xyXG5cclxuICAgICAgICB0aGlzLmxpbmtTZWxlY3Rpb24gPSB0aGlzLmxpbmtTZWxlY3Rpb25cclxuICAgICAgICAgICAgLmRhdGEobGlua1BhaXJzKVxyXG4gICAgICAgICAgICAuZW50ZXIoKS5hcHBlbmQoXCJwYXRoXCIpXHJcbiAgICAgICAgICAgIC5hdHRyKFwiY2xhc3NcIiwgXCJsaW5rXCIpXHJcbiAgICAgICAgICAgIC5hdHRyKFwiZFwiLCAobGluaykgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGxpbmUobGluay5zb3VyY2UucGF0aChsaW5rLnRhcmdldCkpO1xyXG4gICAgICAgICAgICB9KTtcclxuXHJcbiAgICAgICAgdGhpcy5ub2RlU2VsZWN0aW9uID0gdGhpcy5ub2RlU2VsZWN0aW9uXHJcbiAgICAgICAgICAgIC5kYXRhKG5vZGVzLmZpbHRlcigobikgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuICFuLmNoaWxkcmVuO1xyXG4gICAgICAgICAgICB9KSlcclxuICAgICAgICAgICAgLmVudGVyKCkuYXBwZW5kKFwidGV4dFwiKVxyXG4gICAgICAgICAgICAuYXR0cihcImNsYXNzXCIsIChkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gXCJub2RlIFwiICsgZC5kYXRhLmNsYXNzO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuYXR0cihcImR5XCIsIFwiMC4zMWVtXCIpXHJcbiAgICAgICAgICAgIC5hdHRyKFwidHJhbnNmb3JtXCIsIChkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gYHJvdGF0ZSgkeyhkLnggLSA5MCl9KXRyYW5zbGF0ZSgkeyhkLnkgKyAxMCl9LDApYCArXHJcbiAgICAgICAgICAgICAgICAgICAgKGQueCA8IDE4MCA/IFwiXCIgOiBcInJvdGF0ZSgxODApXCIpO1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuc3R5bGUoXCJ0ZXh0LWFuY2hvclwiLCAoZCkgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIGQueCA8IDE4MCA/IFwic3RhcnRcIiA6IFwiZW5kXCI7XHJcbiAgICAgICAgICAgIH0pXHJcbiAgICAgICAgICAgIC50ZXh0KChkKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gZC5kYXRhLmtleTtcclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLm9uKFwibW91c2VvdmVyXCIsIHRoaXMub25Nb3VzZU92ZXIpXHJcbiAgICAgICAgICAgIC5vbihcIm1vdXNlb3V0XCIsIHRoaXMub25Nb3VzZU91dCk7XHJcbiAgICB9XHJcblxyXG4gICAgcHVibGljIGNoYW5nZURpYW1ldGVyKGZhY3RvcjogbnVtYmVyKTogdm9pZCB7XHJcbiAgICAgICAgdGhpcy50b3BHcm91cC5zZWxlY3RDaGlsZHJlbigpLnJlbW92ZSgpO1xyXG5cclxuICAgICAgICB0aGlzLmRpYW1ldGVyICo9IGZhY3RvcjtcclxuICAgICAgICB0aGlzLmRpYW1ldGVyID0gdGhpcy5kaWFtZXRlciA8IDEwMCA/IDEwMCA6ICh0aGlzLmRpYW1ldGVyID4gMTAwMDAgPyAxMDAwMCA6IHRoaXMuZGlhbWV0ZXIpO1xyXG5cclxuICAgICAgICB0aGlzLnJlbmRlcigpO1xyXG4gICAgfVxyXG5cclxuICAgIHByaXZhdGUgb25Nb3VzZU92ZXIgPSAoX2V2ZW50OiBNb3VzZUV2ZW50LCBub2RlOiBDYWxsR3JhcGhMYXlvdXROb2RlKSA9PiB7XHJcbiAgICAgICAgLy8gUmVzZXQgYWxsIG1hcmtlciBmbGFncy5cclxuICAgICAgICB0aGlzLm5vZGVTZWxlY3Rpb24uZWFjaCgobikgPT4ge1xyXG4gICAgICAgICAgICBuLmRhdGEuaXNTb3VyY2UgPSBmYWxzZTtcclxuICAgICAgICAgICAgbi5kYXRhLmlzVGFyZ2V0ID0gZmFsc2U7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIC8vIFNldCBsaW5rIGVsZW1lbnQgQ1NTIGNsYXNzZXMgYmFzZWQgb24gdGhlIHR5cGUgb2Ygbm9kZS5cclxuICAgICAgICAvLyBTZXQgYWxzbyB0aGUgaXNTb3VyY2UvaXNUYXJnZXQgZmxhZ3MgZm9yIG5vZGUgQ1NTIGNsYXNzZXMuXHJcbiAgICAgICAgdGhpcy5saW5rU2VsZWN0aW9uXHJcbiAgICAgICAgICAgIC5jbGFzc2VkKFwibGluay10YXJnZXRcIiwgKGxpbmspID0+IHtcclxuICAgICAgICAgICAgICAgIGlmIChsaW5rLnRhcmdldCA9PT0gbm9kZSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBsaW5rLnNvdXJjZS5kYXRhLmlzU291cmNlID0gdHJ1ZTtcclxuICAgICAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2xhc3NlZChcImxpbmstc291cmNlXCIsIChsaW5rKSA9PiB7XHJcbiAgICAgICAgICAgICAgICBpZiAobGluay5zb3VyY2UgPT09IG5vZGUpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGluay50YXJnZXQuZGF0YS5pc1RhcmdldCA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfSlcclxuICAgICAgICAgICAgLmNsYXNzZWQoXCJsaW5rLWRpbW1lZFwiLCAobGluaykgPT4ge1xyXG4gICAgICAgICAgICAgICAgcmV0dXJuIChsaW5rLnNvdXJjZSAhPT0gbm9kZSkgJiYgKGxpbmsudGFyZ2V0ICE9PSBub2RlKTtcclxuICAgICAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHRoaXMubm9kZVNlbGVjdGlvblxyXG4gICAgICAgICAgICAuY2xhc3NlZChcIm5vZGUtdGFyZ2V0XCIsIChuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbi5kYXRhLmlzVGFyZ2V0O1xyXG4gICAgICAgICAgICB9KVxyXG4gICAgICAgICAgICAuY2xhc3NlZChcIm5vZGUtc291cmNlXCIsIChuKSA9PiB7XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbi5kYXRhLmlzU291cmNlO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgIH07XHJcblxyXG4gICAgcHJpdmF0ZSBvbk1vdXNlT3V0ID0gKF9ldmVudDogTW91c2VFdmVudCwgX25vZGU6IENhbGxHcmFwaExheW91dE5vZGUpID0+IHtcclxuICAgICAgICB0aGlzLmxpbmtTZWxlY3Rpb24uY2xhc3NlZChcImxpbmstZGltbWVkXCIsIGZhbHNlKTtcclxuICAgICAgICB0aGlzLmxpbmtTZWxlY3Rpb25cclxuICAgICAgICAgICAgLmNsYXNzZWQoXCJsaW5rLXRhcmdldFwiLCBmYWxzZSlcclxuICAgICAgICAgICAgLmNsYXNzZWQoXCJsaW5rLXNvdXJjZVwiLCBmYWxzZSk7XHJcblxyXG4gICAgICAgIHRoaXMubm9kZVNlbGVjdGlvblxyXG4gICAgICAgICAgICAuY2xhc3NlZChcIm5vZGUtdGFyZ2V0XCIsIGZhbHNlKVxyXG4gICAgICAgICAgICAuY2xhc3NlZChcIm5vZGUtc291cmNlXCIsIGZhbHNlKTtcclxuICAgIH07XHJcblxyXG4gICAgLyoqXHJcbiAgICAgKiBDb252ZXJ0cyB0aGUgbGlzdCBvZiBjYWxsIGdyYXBoIGVudHJpZXMgaW50byBhIGhpZXJhcmNoeS5cclxuICAgICAqXHJcbiAgICAgKiBAcGFyYW0gZW50cmllcyBUaGUgbGlzdCBvZiBkYXRhIGVudHJpZXMgZnJvbSB0aGUgcmVmZXJlbmNlZCBncmFtbWFycy5cclxuICAgICAqXHJcbiAgICAgKiBAcmV0dXJucyBUaGUgcm9vdCBub2RlIG9mIHRoZSBoaWVyYXJjaHkuXHJcbiAgICAgKi9cclxuICAgIHByaXZhdGUgcGFja2FnZUhpZXJhcmNoeShlbnRyaWVzOiBJQ2FsbEdyYXBoRW50cnlbXSk6IElDYWxsR3JhcGhSZW5kZXJOb2RlIHtcclxuICAgICAgICBjb25zdCBtYXA6IHsgW2tleTogc3RyaW5nXTogSUNhbGxHcmFwaFJlbmRlck5vZGU7IH0gPSB7fTtcclxuICAgICAgICBjb25zdCBtb2R1bGVzOiBzdHJpbmdbXSA9IFtdO1xyXG5cclxuICAgICAgICBjb25zdCBmaW5kID0gKG5hbWU6IHN0cmluZywgcnVsZT86IElDYWxsR3JhcGhFbnRyeSkgPT4ge1xyXG4gICAgICAgICAgICBsZXQgbm9kZSA9IG1hcFtuYW1lXTtcclxuICAgICAgICAgICAgaWYgKCFub2RlKSB7XHJcbiAgICAgICAgICAgICAgICBub2RlID0gcnVsZSBhcyBJQ2FsbEdyYXBoUmVuZGVyTm9kZSB8fCB7XHJcbiAgICAgICAgICAgICAgICAgICAgbmFtZSxcclxuICAgICAgICAgICAgICAgICAgICBjaGlsZHJlbjogW10sXHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgbWFwW25hbWVdID0gbm9kZTtcclxuXHJcbiAgICAgICAgICAgICAgICBpZiAobmFtZS5sZW5ndGggPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgY29uc3QgaSA9IG5hbWUubGFzdEluZGV4T2YoXCIuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgIG5vZGUucGFyZW50ID0gZmluZChuYW1lLnN1YnN0cmluZygwLCBpKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5wYXJlbnQuY2hpbGRyZW4ucHVzaChub2RlKTtcclxuXHJcbiAgICAgICAgICAgICAgICAgICAgLy8gUGljayBvbmUgb3V0IG9mIDEwIGNvbG9yIGNsYXNzZXMgZm9yIHRoaXMgbm9kZS5cclxuICAgICAgICAgICAgICAgICAgICBsZXQgaW5kZXggPSBtb2R1bGVzLmluZGV4T2Yobm9kZS5wYXJlbnQubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKGluZGV4IDwgMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBtb2R1bGVzLnB1c2gobm9kZS5wYXJlbnQubmFtZSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4ID0gbW9kdWxlcy5sZW5ndGggLSAxO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5jbGFzcyA9IGBtb2R1bGUtJHtpbmRleCAlIDEwfWA7XHJcbiAgICAgICAgICAgICAgICAgICAgbm9kZS5rZXkgPSBuYW1lLnN1YnN0cmluZyhpICsgMSk7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuXHJcbiAgICAgICAgICAgIHJldHVybiBub2RlO1xyXG4gICAgICAgIH07XHJcblxyXG4gICAgICAgIGVudHJpZXMuZm9yRWFjaCgocnVsZSkgPT4ge1xyXG4gICAgICAgICAgICBmaW5kKHJ1bGUubmFtZSwgcnVsZSk7XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiBtYXBbXCJcIl07XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBwYWNrYWdlUmVmZXJlbmNlcyhub2RlczogQ2FsbEdyYXBoTGF5b3V0Tm9kZVtdKTogSUNhbGxHcmFwaExheW91dE5vZGVMaW5rW10ge1xyXG4gICAgICAgIGNvbnN0IG1hcDogeyBba2V5OiBzdHJpbmddOiBDYWxsR3JhcGhMYXlvdXROb2RlOyB9ID0ge307XHJcbiAgICAgICAgY29uc3QgcmVmZXJlbmNlczogSUNhbGxHcmFwaExheW91dE5vZGVMaW5rW10gPSBbXTtcclxuXHJcbiAgICAgICAgLy8gQ29tcHV0ZSBhIG1hcCBmcm9tIG5hbWUgdG8gbm9kZS5cclxuICAgICAgICBub2Rlcy5mb3JFYWNoKChub2RlKSA9PiB7XHJcbiAgICAgICAgICAgIG1hcFtub2RlLmRhdGEubmFtZV0gPSBub2RlO1xyXG4gICAgICAgIH0pO1xyXG5cclxuICAgICAgICAvLyBGb3IgZWFjaCBpbXBvcnQsIGNvbnN0cnVjdCBhIGxpbmsgZnJvbSB0aGUgc291cmNlIHRvIHRhcmdldCBub2RlLlxyXG4gICAgICAgIG5vZGVzLmZvckVhY2goKG5vZGUpID0+IHtcclxuICAgICAgICAgICAgaWYgKG5vZGUuZGF0YS5yZWZlcmVuY2VzKSB7XHJcbiAgICAgICAgICAgICAgICBub2RlLmRhdGEucmVmZXJlbmNlcy5mb3JFYWNoKChuYW1lKSA9PiB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlcy5wdXNoKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgc291cmNlOiBtYXBbbm9kZS5kYXRhLm5hbWVdLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICB0YXJnZXQ6IG1hcFtuYW1lXSxcclxuICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfSk7XHJcblxyXG4gICAgICAgIHJldHVybiByZWZlcmVuY2VzO1xyXG4gICAgfVxyXG5cclxufVxyXG4iXX0=